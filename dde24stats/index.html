<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Unofficial DDE 24h Road stats</title>
     
    <!--<script type="text/javascript" src="d3.js"  charset="utf-8"></script>-->
    
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
  
  <div class="header"></div>
  <div class="content">
    <div class="chart"></div>
    <div class="teamList">
      <ul id='tableHeader'>
        <li><span class="color"></span><span class="name">name</span><span class="lap">last lap</span><span class="cps">cps</span></li>
        <li><span class="color"></span><span class="name">name</span><span class="lap">last lap</span><span class="cps">cps</span></li>
        <li><span class="color"></span><span class="name">name</span><span class="lap">last lap</span><span class="cps">cps</span></li>
      </ul>
      <ul id="teams">
      </ul>
    </div>
  </div>
  <div class="footer"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
  <script type="text/javascript"> 
    var raceStartTime = 50400000;
    
    //graph size
    var w = 1000, h = 480;
    var margin = {top: 30, right: 20, bottom: 30, left: 50},
        width = w - margin.left - margin.right,
        height = h - margin.top - margin.bottom;
    
    //load teams and names
    var teams;
    var teamsLoaded = false;
    var dataLoaded = false;
    var data;
    var timeSortedData;
    
    //track last known mouse position in graph
    var mouseX = 0,
        mouseY = 0;
    
    //settings for different 
    //xaxis always the same
    //yscale
    //var y, yaxis, yaxistext
    var x = d3.time.scale()
        //.domain([0, 24)
        .range([0, width]);
    var yNormal = d3.scale.linear().range([height, 0]);
    var yInversed = d3.scale.linear().range([0, height]);
    var yTime = d3.time.scale().range([height,0]);
         
    var xAxis = d3.svg.axis().scale(x).orient("bottom").ticks(22)
        .tickFormat(d3.time.format("%H:%M"));
        
    var yCPAxis = d3.svg.axis().scale(yNormal).orient("left");
    var yRankAxis = d3.svg.axis().scale(yInversed).orient("left").tickFormat(d3.format("d"));
    var yTimeAxis = d3.svg.axis().scale(yTime).orient("left").tickFormat(d3.time.format("%M:%S"));
    
    var GRAPHTYPE = {
        RANK:     {desc:"rank",      index:0, yLabel:"rank", yAxis: yRankAxis, y:yInversed, dataFunc:function(d){ return d.rank}},
        LASTLAP:  {desc: "last lap", index:1, yLabel:"time (s)", yAxis: yTimeAxis, y:yTime, dataFunc:function(d){ return d.lastLap}}, 
        CPSTOTAL: {desc: "total CPs",index:2, yLabel:"CPs", yAxis: yCPAxis, y:yNormal, dataFunc:function(d){ return d.cps}},
        CPSCHANGE:{desc: "new CPs",  index:3, yLabel:"CP change", yAxis: yCPAxis, y:yNormal, dataFunc:function(d){ return d.cpsChange}},
    }
    graphType = "RANK";
    
        
        
    d3.csv("teams.csv", function(d) {return {
        id: +d.ID,
        team: d.teamName,
        playerID: +d.playerID,
        player: d.playerName
      };}, 
      function(error, rows) {
      console.log(error);
      if (error) throw error;
      
      teams = d3.nest()
          .key(function(d) {return d.id;})
          .entries(rows);
      teamsLoaded = true;
    });

    
        
    var svg = d3.select(".chart").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom);
          
    var testData; 
     
    function secToRaceTime(s, offset) {
      //var startTime = 50399999 //15:00
      return new Date(+s*1000+offset);
    }
    
    function getTeamName(teamID) {
        try {
          return teams[teamID].values[0].team; 
        }
        catch(e){
          console.log(e);
        } 
        return "unknown";
    }
    function getPlayerName(teamID, playerID) {
        try {
          return teams[teamID].values[playerID].player; 
        }
        catch(e){
          console.log(e);
        } 
        return "unknown";
    }

          
    //d3.csv("generatedData.csv")
    
    d3.csv("generatedData.csv", function(d) {
      return {
        //time, session, teamID, playerID, rank, lastLap, cpsTotal, cpsChange
        time: secToRaceTime(d.time, raceStartTime),
        session: +d.session,
        teamID: +d.teamID,
        playerID: +d.playerID,
        rank: +d.rank,
        lastLap: secToRaceTime(d.lastLap, 0),
        cps: +d.cpsTotal,
        cpsChange: +d.cpsChange
    };
    }, function(error, rows) {
      console.log(error);
      if (error) throw error;
      
      data = rows;
      dataLoaded = true;
      //do stuff to draw lines
      //drawStuff()
      drawGraph();
      updateTeamTable(0);
    });
    
    function handleMouseMovement(mouse) { //TODO display time text, display 
        mouseY = mouse[1]-margin.top;
        mouseX = mouse[0]-margin.left;
        //if inside lines part
        if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
            d3.select("g.mouseIndicator").select("line")
            .attr("class", "active")
            .attr("x1", mouse[0])
            .attr("x2", mouse[0]);
            
            var relX = mouseX/width;
            //console.log(relX);
            updateTeamTable(relX);
            
        } else { //must be round edges, disable indicator
            d3.select("g.mouseIndicator").select("line")
            .attr("class", "inactive");
        }
    
    }
    
    function drawGraph() {
      if (dataLoaded = true) {
        d3.select("svg").html(function() {return});
        
        testData = d3.nest()
            .key(function(d) { return d.teamID; })
            .entries(data);
            
        timeSortedData = d3.nest()
          .key(function(d){return d.time; })
          .entries(data);
         
        y = GRAPHTYPE[graphType].y;
         
        var line = d3.svg.line()
        .x(function(d) { return x(d.time); })
        .y(function(d) { return y(GRAPHTYPE[graphType].dataFunc(d)); });
      
        x.domain(d3.extent(data, function(d) { return d.time; })); 
        y.domain(d3.extent(data, function(d) { return GRAPHTYPE[graphType].dataFunc(d); })); //THESE, 
        
        d3.select("svg").append("g")
          .attr("class", "lines")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
  //      svg.append("path")
  //          .datum(data)
  //          .attr("class", "line")
  //          .attr("d", line);
          d3.select("svg").select("g.lines").selectAll("path")
              .data(testData)
              .enter().append("path")
              .attr("class", "line")
              .style("stroke", d3.rgb(200,0,0))
              //.on('mouseover', function(d, i) {	console.log(d); console.log(i); console.log(d3.event); console.log(d3.mouse(d3.select("path").node()));	})
              .attr("d", function(d){return line(d.values);}); //THESE
          
          d3.select("svg")
              .on('mousemove', function(d,i) { handleMouseMovement(d3.mouse(d3.select("svg").node())); });
          
        d3.select("svg").append("g")
            .attr("class", "x axis")
            .attr("transform", "translate("+ margin.left + ", " + (height+margin.top) + ")")
            .call(xAxis);
            
        d3.select("svg").append("g")
            .attr("class", "mouseIndicator")
            .append("line")
            .attr("class", "inactive")
            .attr("y1", ""+margin.top)
            .attr("y2", (height+margin.top)+"");
            
        d3.select("svg").append("g")
        .attr("class", "y axis")
        .attr("transform", "translate("+ margin.left +", " + margin.top + ")")
        .call(GRAPHTYPE[graphType].yAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "-2.7em")
        .style("text-anchor", "end")
        .text(GRAPHTYPE[graphType].yLabel); 
        
        //Top bar
        drawButtons();
        
        d3.select("svg").append("g")
          .attr("class", "timeField")
          .append("text")
          .attr("x", (width+margin.left)+"")
          .attr("y", 20);
      }
    }
    
    function updateGraphType(typeString) {
      if (graphType.desc == typeString) {
        return;
      }
      
      d3.select("g.graphButtons").selectAll("text").attr("class", "inactive");
      for (i in GRAPHTYPE) {
        if (GRAPHTYPE[i].desc == typeString) {
          d3.select("g.graphButtons").selectAll("text")[0][GRAPHTYPE[i].index]
            .setAttribute("class", "active");
          graphType = i;
          break;
        }
      }
      drawGraph();
      
    }
    
    function drawButtons() {
      var totalOffset = 0;
      var distance = 30;
      var buttonLength, button;
      var buttonGroup = d3.select("svg").append("g").attr("class", "graphButtons")
        .attr("transform", "translate(" + margin.left+",20)");
      
      for (i in GRAPHTYPE) {
        console.log(i, GRAPHTYPE[i].desc);
        button = buttonGroup.append("text")
          .attr("class", "inactive")
          .attr("x", totalOffset + "")
          .text(GRAPHTYPE[i].desc)
          .on("click", function(d,i) {updateGraphType(this.childNodes[0].nodeValue);});
          
          if (i == graphType) {
            console.log(i)
            button.attr("class", "active");
          }
        buttonLength = button.node().getComputedTextLength();
        totalOffset += buttonLength + distance;
      }
      

    }
    
    function updateTeamTable(timeValue) {
      if (timeValue == -1) {
        return;
      }
      
      if (teamsLoaded && dataLoaded) {
        selectedTime = Math.floor((timeSortedData.length-1) * timeValue)
        //console.log(selectedTime);
        
        teamData = d3.nest()
            .key(function(d) { return d.teamID;})
            .entries(timeSortedData[selectedTime].values)
        
        var lapTimeFormat = d3.time.format("%M:%S.%L");
        liElement = d3.select(".teamList").select("ul#teams").selectAll("li.driver");
        if (liElement[0].length == 0) {
            liElement.data(teamData)
          .enter().append("li")
          .attr("class", "driver")
          .html(function(d) { row = d.values[0]; 
            return "<span class=\"color\">" +
            "</span><span class=\"name\">" + getPlayerName(row.teamID, row.playerID) +
            "</span><span class=\"lap\">" + lapTimeFormat(row.lastLap)+ 
            "</span><span class=\"cps\">" + row.cps+ "</span>";});
        }
        else {
            liElement.data(teamData)
          .attr("class", "driver")
          .call(function(c) { c
              .html(function(d) { row = d.values[0]; 
                return "<span class=\"color\">" +
                "</span><span class=\"name\">" + getPlayerName(row.teamID, row.playerID) +
                "</span><span class=\"lap\">" + lapTimeFormat(row.lastLap)+ 
                "</span><span class=\"cps\">" + row.cps+ "</span>";})});
        }
        
        //also change time at top of svg
        var generalTimeFormat = d3.time.format("%H:%M:%S");
        d3.select("g.timeField").select("text")
            .html(function(d) { return generalTimeFormat(timeSortedData[selectedTime].values[0].time);});
        
      }
    }
    
  </script>
  </body>
</html>
